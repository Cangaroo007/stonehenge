// Prisma Schema for Stone Henge MVP

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// USER & AUTHENTICATION
// ============================================

model User {
  id           Int       @id @default(autoincrement())
  email        String    @unique
  passwordHash String    @map("password_hash")
  name         String?
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  quotes       Quote[]

  @@map("users")
}

// ============================================
// CUSTOMERS
// ============================================

model Customer {
  id        Int       @id @default(autoincrement())
  name      String
  company   String?
  email     String?
  phone     String?
  address   String?
  notes     String?
  createdAt DateTime  @default(now()) @map("created_at")
  updatedAt DateTime  @updatedAt @map("updated_at")

  // Pricing classification
  clientTypeId  String?     @map("client_type_id")
  clientType    ClientType? @relation(fields: [clientTypeId], references: [id])
  clientTierId  String?     @map("client_tier_id")
  clientTier    ClientTier? @relation(fields: [clientTierId], references: [id])

  quotes    Quote[]

  @@map("customers")
}

// ============================================
// MATERIALS
// ============================================

model Material {
  id          Int       @id @default(autoincrement())
  name        String
  collection  String?
  description String?
  pricePerSqm Decimal   @map("price_per_sqm") @db.Decimal(10, 2)
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  pieces      QuotePiece[]

  @@map("materials")
}

// ============================================
// PRICING RULES
// ============================================

model PricingRule {
  id          Int       @id @default(autoincrement())
  category    String    // 'thickness', 'edge', 'cutout', 'feature'
  name        String
  description String?
  price       Decimal   @db.Decimal(10, 2)
  priceType   String    @map("price_type") // 'fixed', 'per_meter', 'per_sqm', 'multiplier'
  isActive    Boolean   @default(true) @map("is_active")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  pieceFeatures PieceFeature[]

  @@map("pricing_rules")
}

// ============================================
// QUOTES
// ============================================

model Quote {
  id             Int       @id @default(autoincrement())
  quoteNumber    String    @unique @map("quote_number")
  revision       Int       @default(1)
  
  // Customer
  customerId     Int?      @map("customer_id")
  customer       Customer? @relation(fields: [customerId], references: [id])
  
  // Project details
  projectName    String?   @map("project_name")
  projectAddress String?   @map("project_address")
  
  // Status
  status         String    @default("draft") // draft, sent, accepted, declined
  
  // Pricing
  subtotal       Decimal   @default(0) @db.Decimal(10, 2)
  taxRate        Decimal   @default(10) @map("tax_rate") @db.Decimal(5, 2)
  taxAmount      Decimal   @default(0) @map("tax_amount") @db.Decimal(10, 2)
  total          Decimal   @default(0) @db.Decimal(10, 2)
  
  // Terms
  validUntil     DateTime? @map("valid_until")
  notes          String?
  internalNotes  String?   @map("internal_notes")
  
  // Metadata
  createdBy      Int?      @map("created_by")
  createdByUser  User?     @relation(fields: [createdBy], references: [id])
  createdAt      DateTime  @default(now()) @map("created_at")
  updatedAt      DateTime  @updatedAt @map("updated_at")
  
  // Relations
  rooms           QuoteRoom[]
  files           QuoteFile[]
  drawingAnalysis QuoteDrawingAnalysis?

  @@map("quotes")
}

model QuoteRoom {
  id        Int       @id @default(autoincrement())
  quoteId   Int       @map("quote_id")
  quote     Quote     @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  name      String    // Kitchen, Bathroom, Ensuite, etc.
  sortOrder Int       @default(0) @map("sort_order")
  
  pieces    QuotePiece[]

  @@map("quote_rooms")
}

model QuotePiece {
  id           Int       @id @default(autoincrement())
  roomId       Int       @map("room_id")
  room         QuoteRoom @relation(fields: [roomId], references: [id], onDelete: Cascade)
  
  // Material
  materialId   Int?      @map("material_id")
  material     Material? @relation(fields: [materialId], references: [id])
  materialName String?   @map("material_name") // Denormalized for display
  
  // Description
  description  String?
  
  // Dimensions
  lengthMm     Int       @map("length_mm")
  widthMm      Int       @map("width_mm")
  thicknessMm  Int       @map("thickness_mm")
  areaSqm      Decimal   @map("area_sqm") @db.Decimal(10, 4)
  
  // Pricing
  materialCost Decimal   @default(0) @map("material_cost") @db.Decimal(10, 2)
  featuresCost Decimal   @default(0) @map("features_cost") @db.Decimal(10, 2)
  totalCost    Decimal   @default(0) @map("total_cost") @db.Decimal(10, 2)
  
  sortOrder    Int       @default(0) @map("sort_order")
  
  features     PieceFeature[]

  @@map("quote_pieces")
}

model PieceFeature {
  id            Int          @id @default(autoincrement())
  pieceId       Int          @map("piece_id")
  piece         QuotePiece   @relation(fields: [pieceId], references: [id], onDelete: Cascade)
  
  pricingRuleId Int?         @map("pricing_rule_id")
  pricingRule   PricingRule? @relation(fields: [pricingRuleId], references: [id])
  
  name          String
  quantity      Int          @default(1)
  unitPrice     Decimal      @map("unit_price") @db.Decimal(10, 2)
  totalPrice    Decimal      @map("total_price") @db.Decimal(10, 2)

  @@map("piece_features")
}

// ============================================
// FILES
// ============================================

model QuoteFile {
  id           Int      @id @default(autoincrement())
  quoteId      Int      @map("quote_id")
  quote        Quote    @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  filename     String
  originalName String   @map("original_name")
  filePath     String   @map("file_path")
  fileType     String?  @map("file_type")
  fileSize     Int?     @map("file_size")
  analysisJson Json?    @map("analysis_json")
  uploadedAt   DateTime @default(now()) @map("uploaded_at")

  @@map("quote_files")
}

// ============================================
// DRAWING ANALYSIS
// ============================================

model QuoteDrawingAnalysis {
  id             Int      @id @default(autoincrement())
  quoteId        Int      @unique @map("quote_id")
  quote          Quote    @relation(fields: [quoteId], references: [id], onDelete: Cascade)
  filename       String
  analyzedAt     DateTime @default(now()) @map("analyzed_at")
  drawingType    String   @map("drawing_type") // "job_sheet", "cad_professional", etc.
  rawResults     Json     @map("raw_results") // Full API response
  metadata       Json?    // Extracted job number, thickness, etc.
  importedPieces String[] @map("imported_pieces") // IDs of pieces created from this analysis

  @@map("quote_drawing_analyses")
}

// ============================================
// PRICING ENTITIES
// ============================================

model EdgeType {
  id          String   @id @default(cuid())
  name        String   @unique  // "Pencil Round", "Bullnose", etc.
  description String?
  category    String   @default("polish")  // "polish", "waterfall", "apron"
  baseRate    Decimal  @db.Decimal(10, 2)  // $ per linear meter
  isActive    Boolean  @default(true)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("edge_types")
}

model CutoutType {
  id          String   @id @default(cuid())
  name        String   @unique  // "Undermount Sink", "Tap Hole", etc.
  description String?
  baseRate    Decimal  @db.Decimal(10, 2)  // $ per cutout (fixed price)
  isActive    Boolean  @default(true)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("cutout_types")
}

model ThicknessOption {
  id          String   @id @default(cuid())
  name        String   @unique  // "20mm", "40mm"
  value       Int      // 20, 40 (actual mm)
  multiplier  Decimal  @db.Decimal(5, 2) @default(1.00)  // 1.0 for 20mm, 1.3 for 40mm
  isDefault   Boolean  @default(false)
  isActive    Boolean  @default(true)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("thickness_options")
}

model ClientType {
  id          String     @id @default(cuid())
  name        String     @unique  // "Cabinet Maker", "Builder", etc.
  description String?
  isActive    Boolean    @default(true)
  sortOrder   Int        @default(0)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  customers   Customer[]

  @@map("client_types")
}

model ClientTier {
  id          String     @id @default(cuid())
  name        String     @unique  // "Tier 1", "Tier 2", "Tier 3"
  description String?
  priority    Int        @default(0)  // Higher = better pricing, used for rule matching
  isDefault   Boolean    @default(false)
  isActive    Boolean    @default(true)
  sortOrder   Int        @default(0)
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt
  customers   Customer[]

  @@map("client_tiers")
}

// ============================================
// SETTINGS (Key-Value store for app config)
// ============================================

model Setting {
  id        Int      @id @default(autoincrement())
  key       String   @unique
  value     String
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("settings")
}
